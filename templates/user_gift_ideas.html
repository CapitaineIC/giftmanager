<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadeaux Infojfc</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.16/dist/tailwind.min.css">
    <style>
        /* Add any custom styles here */
        .description {
        max-width: 400px; /* Adjust the max-width value to control the width */
    }

    /* Style for the pop-up */
    #popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px;
      background-color: #fff;
      border: 1px solid #ccc;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      z-index: 999;
    }

    /* Style for the overlay */
    #overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 998;
    }

    /* Style for the close button in the pop-up */
    #close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
    }
    </style>
</head>
<body class="text-gray-900 font-sans">
    <header class="bg-white text-gray-900 p-4">
        <nav class="container mx-auto flex justify-between items-center">
            <button id="backButton" class="text-2xl px-4 py-2">
                Retour
            </button>
            
            <a href="{{ url_for('add_idea', selected_user_id=user_gift_ideas[0].user_id) }}" class="bg-blue-500 text-white px-4 py-2 rounded">Nouvelle idée</a>
            <!-- The button will use the user_id of the first user in the list, which corresponds to the selected user -->
        </nav>
    </header>
    <main class="container mx-auto p-8">
        <section class="bg-gray-100 shadow-lg rounded-lg p-6">
            <h1 class="text-2xl font-semibold mb-4">Liste idées de {{ user_namels }}</h1>
            <ul class="space-y-4">
                {% for gift_idea in user_gift_ideas %}
                <li class="bg-white p-4 shadow-md rounded-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-lg font-semibold">{{ gift_idea.gift_name }}</h2>
                            <p class="text-gray-600 description">{{ gift_idea.description }}</p>
                            <!-- Display who added the gift idea below the description -->
                            <p class="text-gray-600">Par: {{ get_full_name(gift_idea.added_by) }}</p>
                        </div>
                        {% if gift_idea.added_by == session['username'] %}
                        <button class="bg-red-500 text-white px-3 py-1 rounded delete-idea-button" data-idea-id="{{ gift_idea.gift_idea_id }}">
                            <img src="{{ url_for('static', filename='icons/delete.svg') }}" alt="Delete Icon">
                        </button>
                    {% endif %}

                    <!-- Add the "Edit" button here -->
                    {% if gift_idea.added_by == session['username'] %}
                    <a href="#" class="bg-blue-500 text-white px-3 py-1 rounded edit-idea-link" data-idea-id="{{ gift_idea.gift_idea_id }}">
                        <img src="{{ url_for('static', filename='icons/edit.svg') }}" alt="Edit Icon">
                    </a>
                     {% endif %}
                    
                        <!-- Place the "Open Link" button after the description -->
                        <div class="flex items-center space-x-2">
                            {% if gift_idea.link %}
                            <a href="{{ gift_idea.link }}" target="_blank" class="bg-blue-500 text-white px-3 py-1 rounded open-link-button">
                                <img src="{{ url_for('static', filename='icons/link.svg') }}" alt="Open Link">
                            </a>
                            {% else %}
                                <div style="width: 0; height: 0; overflow: hidden; visibility: hidden;"></div>
                            {% endif %}
                        </div>
                    </div>

                    {% if gift_idea.bought_by %}
                        <p class="text-green-500">Acheté par: {{ get_full_name(gift_idea.bought_by) }}</p>
                        {% if gift_idea.bought_by == session['username'] %}
                            <button class="bg-red-500 text-white px-3 py-1 rounded mark-as-not-bought-button"
                                data-idea-id="{{ gift_idea.gift_idea_id }}">Annuler l'achat
                            </button>
                        {% endif %}
                    {% else %}
                    <strong>Idée disponible</strong>
                        <button class="bg-green-500 text-white px-3 py-1 rounded mark-as-bought-button"
                            data-idea-id="{{ gift_idea.gift_idea_id }}">Achat réalisé
                        </button>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </section>
    </main> 
    
        <!-- Pop-up content -->
        <div id="popup">
            <div id="close-btn" onclick="closePopup()">X</div>
            <p>This is an example pop-up explaining the use of the button.</p>
        </div>
    
        <!-- Overlay to cover the background when the pop-up is open -->
        <div id="overlay"></div>
    <script>
        const backButton = document.getElementById('backButton');
        backButton.addEventListener('click', () => {
            window.location.href = '/dashboard'; // Replace '/dashboard' with the actual URL of your dashboard page
        });
    
        function markIdeaAsBought(ideaId, button) {
            fetch(`/mark_as_bought/${ideaId}`, {
                method: 'POST',
            })
            .then(response => {
                // Always reload the page, regardless of the response status
                location.reload();
    
                if (response.ok) {
                    // Hide the button and update the text
                    button.style.display = 'none';
                    button.parentNode.querySelector('.text-green-500').textContent = `Bought by: ${currentUser}`;
                }
            })
            .catch(error => {
                console.error('Error marking idea as bought:', error);
            });
        }
    
        function markIdeaAsNotBought(ideaId, button) {
            fetch(`/mark_as_not_bought/${ideaId}`, {
                method: 'POST',
            })
            .then(response => {
                if (response.ok) {
                    // Hide the button and update the text
                    button.style.display = 'none';
                    button.parentNode.querySelector('.text-green-500').textContent = '';
                    // Reload the page
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Error marking idea as not bought:', error);
            });
        }
    
        document.querySelectorAll('.mark-as-bought-button').forEach(button => {
            button.addEventListener('click', () => {
                const ideaId = button.getAttribute('data-idea-id');
                markIdeaAsBought(ideaId, button);
            });
        });
    
        document.querySelectorAll('.mark-as-not-bought-button').forEach(button => {
            button.addEventListener('click', () => {
                const ideaId = button.getAttribute('data-idea-id');
                markIdeaAsNotBought(ideaId, button);
            });
        });
    
        // Add the code for deleting an idea here
        document.querySelectorAll('.delete-idea-button').forEach(button => {
            button.addEventListener('click', () => {
                const ideaId = button.getAttribute('data-idea-id');
                deleteIdea(ideaId);
            });
        });
    
        function deleteIdea(ideaId) {
            fetch(`/delete_idea/${ideaId}`, {
                method: 'DELETE',
            })
            .then(response => {
                if (response.ok) {
                    // Remove the deleted idea from the page
                    const ideaElement = document.querySelector(`[data-idea-id="${ideaId}"]`);
                    ideaElement.remove();
                }
            })
            .catch(error => {
                console.error('Error deleting idea:', error);
            });
        }

    // Add the code for editing an idea here
    document.querySelectorAll('.edit-idea-link').forEach(link => {
        link.addEventListener('click', (event) => {
            event.preventDefault(); // Prevent the default link behavior (i.e., navigating to a new page)
            const ideaId = link.getAttribute('data-idea-id');
            editIdea(ideaId);
        });
    });

    function editIdea(ideaId) {
        // Redirect to the edit page for the specific idea
        window.location.href = `/edit_idea/${ideaId}`;
    }   

        // Function to open the pop-up
        function openPopup() {
            document.getElementById('popup').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';

            // Automatically close the pop-up after 20 seconds
            setTimeout(closePopup, 20000);
        }

        // Function to close the pop-up
        function closePopup() {
            document.getElementById('popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        // Function to check if a week has passed since the last popup
        function hasWeekPassed() {
            const lastPopupDate = localStorage.getItem('lastPopupDate');

            if (!lastPopupDate) {
                // If there is no stored date, it's the first time, show the popup
                return true;
            }

            const oneWeekInMilliseconds = 7 * 24 * 60 * 60 * 1000; // One week in milliseconds
            const currentTime = new Date().getTime();
            const lastPopupTime = new Date(lastPopupDate).getTime();

            return currentTime - lastPopupTime >= oneWeekInMilliseconds;
        }

        // Automatically open the pop-up if a week has passed since the last popup
        if (hasWeekPassed()) {
            openPopup();
            // Update the stored date
            localStorage.setItem('lastPopupDate', new Date().toJSON());
        }
        
    </script>    
    
</body>
</html>
